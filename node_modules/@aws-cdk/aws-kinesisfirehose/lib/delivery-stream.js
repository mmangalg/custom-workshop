"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DeliveryStream = exports.StreamEncryption = void 0;
const jsiiDeprecationWarnings = require("../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const cloudwatch = require("@aws-cdk/aws-cloudwatch");
const ec2 = require("@aws-cdk/aws-ec2");
const iam = require("@aws-cdk/aws-iam");
const kms = require("@aws-cdk/aws-kms");
const cdk = require("@aws-cdk/core");
const region_info_1 = require("@aws-cdk/region-info");
const constructs_1 = require("constructs");
const kinesisfirehose_canned_metrics_generated_1 = require("./kinesisfirehose-canned-metrics.generated");
const kinesisfirehose_generated_1 = require("./kinesisfirehose.generated");
const PUT_RECORD_ACTIONS = [
    'firehose:PutRecord',
    'firehose:PutRecordBatch',
];
/**
 * Base class for new and imported Kinesis Data Firehose delivery streams.
 */
class DeliveryStreamBase extends cdk.Resource {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        this.connections = setConnections(this);
    }
    grant(grantee, ...actions) {
        return iam.Grant.addToPrincipal({
            resourceArns: [this.deliveryStreamArn],
            grantee: grantee,
            actions: actions,
        });
    }
    grantPutRecords(grantee) {
        return this.grant(grantee, ...PUT_RECORD_ACTIONS);
    }
    metric(metricName, props) {
        return new cloudwatch.Metric({
            namespace: 'AWS/Firehose',
            metricName: metricName,
            dimensionsMap: {
                DeliveryStreamName: this.deliveryStreamName,
            },
            ...props,
        }).attachTo(this);
    }
    metricIncomingBytes(props) {
        return this.cannedMetric(kinesisfirehose_canned_metrics_generated_1.FirehoseMetrics.incomingBytesSum, props);
    }
    metricIncomingRecords(props) {
        return this.cannedMetric(kinesisfirehose_canned_metrics_generated_1.FirehoseMetrics.incomingRecordsSum, props);
    }
    metricBackupToS3Bytes(props) {
        return this.cannedMetric(kinesisfirehose_canned_metrics_generated_1.FirehoseMetrics.backupToS3BytesSum, props);
    }
    metricBackupToS3DataFreshness(props) {
        return this.cannedMetric(kinesisfirehose_canned_metrics_generated_1.FirehoseMetrics.backupToS3DataFreshnessAverage, props);
    }
    metricBackupToS3Records(props) {
        return this.cannedMetric(kinesisfirehose_canned_metrics_generated_1.FirehoseMetrics.backupToS3RecordsSum, props);
    }
    cannedMetric(fn, props) {
        return new cloudwatch.Metric({
            ...fn({ DeliveryStreamName: this.deliveryStreamName }),
            ...props,
        }).attachTo(this);
    }
}
/**
 * Options for server-side encryption of a delivery stream.
 */
var StreamEncryption;
(function (StreamEncryption) {
    /**
     * Data in the stream is stored unencrypted.
     */
    StreamEncryption[StreamEncryption["UNENCRYPTED"] = 0] = "UNENCRYPTED";
    /**
     * Data in the stream is stored encrypted by a KMS key managed by the customer.
     */
    StreamEncryption[StreamEncryption["CUSTOMER_MANAGED"] = 1] = "CUSTOMER_MANAGED";
    /**
     * Data in the stream is stored encrypted by a KMS key owned by AWS and managed for use in multiple AWS accounts.
     */
    StreamEncryption[StreamEncryption["AWS_OWNED"] = 2] = "AWS_OWNED";
})(StreamEncryption = exports.StreamEncryption || (exports.StreamEncryption = {}));
/**
 * Create a Kinesis Data Firehose delivery stream
 *
 * @resource AWS::KinesisFirehose::DeliveryStream
 */
class DeliveryStream extends DeliveryStreamBase {
    constructor(scope, id, props) {
        var _b, _c, _d, _e;
        super(scope, id, {
            physicalName: props.deliveryStreamName,
        });
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_kinesisfirehose_DeliveryStreamProps(props);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.constructor);
            }
            throw error;
        }
        if (props.destinations.length !== 1) {
            throw new Error(`Only one destination is allowed per delivery stream, given ${props.destinations.length}`);
        }
        const role = (_b = props.role) !== null && _b !== void 0 ? _b : new iam.Role(this, 'Service Role', {
            assumedBy: new iam.ServicePrincipal('firehose.amazonaws.com'),
        });
        this.grantPrincipal = role;
        if (props.sourceStream &&
            (props.encryption === StreamEncryption.AWS_OWNED || props.encryption === StreamEncryption.CUSTOMER_MANAGED || props.encryptionKey)) {
            throw new Error('Requested server-side encryption but delivery stream source is a Kinesis data stream. Specify server-side encryption on the data stream instead.');
        }
        if ((props.encryption === StreamEncryption.AWS_OWNED || props.encryption === StreamEncryption.UNENCRYPTED) && props.encryptionKey) {
            throw new Error(`Specified stream encryption as ${StreamEncryption[props.encryption]} but provided a customer-managed key`);
        }
        const encryptionKey = (_c = props.encryptionKey) !== null && _c !== void 0 ? _c : (props.encryption === StreamEncryption.CUSTOMER_MANAGED ? new kms.Key(this, 'Key') : undefined);
        const encryptionConfig = (encryptionKey || (props.encryption === StreamEncryption.AWS_OWNED)) ? {
            keyArn: encryptionKey === null || encryptionKey === void 0 ? void 0 : encryptionKey.keyArn,
            keyType: encryptionKey ? 'CUSTOMER_MANAGED_CMK' : 'AWS_OWNED_CMK',
        } : undefined;
        /*
         * In order for the service role to have access to the encryption key before the delivery stream is created, the
         * CfnDeliveryStream below should have a dependency on the grant returned by the function call below:
         * > `keyGrant?.applyBefore(resource)`
         * However, an error during synthesis is thrown if this is added:
         * > ${Token[PolicyDocument.###]} does not implement DependableTrait
         * Data will not be lost if the permissions are not granted to the service role immediately; Firehose has a 24 hour
         * period where data will be buffered and retried if access is denied to the encryption key. For that reason, it is
         * acceptable to omit the dependency for now. See: https://github.com/aws/aws-cdk/issues/15790
         */
        encryptionKey === null || encryptionKey === void 0 ? void 0 : encryptionKey.grantEncryptDecrypt(role);
        const sourceStreamConfig = props.sourceStream ? {
            kinesisStreamArn: props.sourceStream.streamArn,
            roleArn: role.roleArn,
        } : undefined;
        const readStreamGrant = (_d = props.sourceStream) === null || _d === void 0 ? void 0 : _d.grantRead(role);
        const destinationConfig = props.destinations[0].bind(this, {});
        const resource = new kinesisfirehose_generated_1.CfnDeliveryStream(this, 'Resource', {
            deliveryStreamEncryptionConfigurationInput: encryptionConfig,
            deliveryStreamName: props.deliveryStreamName,
            deliveryStreamType: props.sourceStream ? 'KinesisStreamAsSource' : 'DirectPut',
            kinesisStreamSourceConfiguration: sourceStreamConfig,
            ...destinationConfig,
        });
        (_e = destinationConfig.dependables) === null || _e === void 0 ? void 0 : _e.forEach(dependable => resource.node.addDependency(dependable));
        if (readStreamGrant) {
            resource.node.addDependency(readStreamGrant);
        }
        this.deliveryStreamArn = this.getResourceArnAttribute(resource.attrArn, {
            service: 'kinesis',
            resource: 'deliverystream',
            resourceName: this.physicalName,
        });
        this.deliveryStreamName = this.getResourceNameAttribute(resource.ref);
    }
    /**
     * Import an existing delivery stream from its name.
     */
    static fromDeliveryStreamName(scope, id, deliveryStreamName) {
        return this.fromDeliveryStreamAttributes(scope, id, { deliveryStreamName });
    }
    /**
     * Import an existing delivery stream from its ARN.
     */
    static fromDeliveryStreamArn(scope, id, deliveryStreamArn) {
        return this.fromDeliveryStreamAttributes(scope, id, { deliveryStreamArn });
    }
    /**
     * Import an existing delivery stream from its attributes.
     */
    static fromDeliveryStreamAttributes(scope, id, attrs) {
        var _b, _c;
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_kinesisfirehose_DeliveryStreamAttributes(attrs);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.fromDeliveryStreamAttributes);
            }
            throw error;
        }
        if (!attrs.deliveryStreamName && !attrs.deliveryStreamArn) {
            throw new Error('Either deliveryStreamName or deliveryStreamArn must be provided in DeliveryStreamAttributes');
        }
        const deliveryStreamName = (_b = attrs.deliveryStreamName) !== null && _b !== void 0 ? _b : cdk.Stack.of(scope).splitArn(attrs.deliveryStreamArn, cdk.ArnFormat.SLASH_RESOURCE_NAME).resourceName;
        if (!deliveryStreamName) {
            throw new Error(`No delivery stream name found in ARN: '${attrs.deliveryStreamArn}'`);
        }
        const deliveryStreamArn = (_c = attrs.deliveryStreamArn) !== null && _c !== void 0 ? _c : cdk.Stack.of(scope).formatArn({
            service: 'firehose',
            resource: 'deliverystream',
            resourceName: attrs.deliveryStreamName,
            arnFormat: cdk.ArnFormat.SLASH_RESOURCE_NAME,
        });
        class Import extends DeliveryStreamBase {
            constructor() {
                var _b;
                super(...arguments);
                this.deliveryStreamName = deliveryStreamName;
                this.deliveryStreamArn = deliveryStreamArn;
                this.grantPrincipal = (_b = attrs.role) !== null && _b !== void 0 ? _b : new iam.UnknownPrincipal({ resource: this });
            }
        }
        return new Import(scope, id);
    }
}
exports.DeliveryStream = DeliveryStream;
_a = JSII_RTTI_SYMBOL_1;
DeliveryStream[_a] = { fqn: "@aws-cdk/aws-kinesisfirehose.DeliveryStream", version: "1.153.1" };
function setConnections(scope) {
    const stack = cdk.Stack.of(scope);
    const mappingId = '@aws-cdk/aws-kinesisfirehose.CidrBlocks';
    let cfnMapping = constructs_1.Node.of(stack).tryFindChild(mappingId);
    if (!cfnMapping) {
        const mapping = {};
        region_info_1.RegionInfo.regions.forEach((regionInfo) => {
            if (regionInfo.firehoseCidrBlock) {
                mapping[regionInfo.name] = {
                    FirehoseCidrBlock: regionInfo.firehoseCidrBlock,
                };
            }
        });
        cfnMapping = new cdk.CfnMapping(stack, mappingId, {
            mapping,
            lazy: true,
        });
    }
    const cidrBlock = cfnMapping.findInMap(stack.region, 'FirehoseCidrBlock');
    return new ec2.Connections({
        peer: ec2.Peer.ipv4(cidrBlock),
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsaXZlcnktc3RyZWFtLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGVsaXZlcnktc3RyZWFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHNEQUFzRDtBQUN0RCx3Q0FBd0M7QUFDeEMsd0NBQXdDO0FBRXhDLHdDQUF3QztBQUN4QyxxQ0FBcUM7QUFDckMsc0RBQWtEO0FBQ2xELDJDQUE2QztBQUU3Qyx5R0FBNkU7QUFDN0UsMkVBQWdFO0FBRWhFLE1BQU0sa0JBQWtCLEdBQUc7SUFDekIsb0JBQW9CO0lBQ3BCLHlCQUF5QjtDQUMxQixDQUFDO0FBeUVGOztHQUVHO0FBQ0gsTUFBZSxrQkFBbUIsU0FBUSxHQUFHLENBQUMsUUFBUTtJQWFwRCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLFFBQTJCLEVBQUU7UUFDckUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDekM7SUFFTSxLQUFLLENBQUMsT0FBdUIsRUFBRSxHQUFHLE9BQWlCO1FBQ3hELE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUM7WUFDOUIsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDO1lBQ3RDLE9BQU8sRUFBRSxPQUFPO1lBQ2hCLE9BQU8sRUFBRSxPQUFPO1NBQ2pCLENBQUMsQ0FBQztLQUNKO0lBRU0sZUFBZSxDQUFDLE9BQXVCO1FBQzVDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDO0tBQ25EO0lBRU0sTUFBTSxDQUFDLFVBQWtCLEVBQUUsS0FBZ0M7UUFDaEUsT0FBTyxJQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUM7WUFDM0IsU0FBUyxFQUFFLGNBQWM7WUFDekIsVUFBVSxFQUFFLFVBQVU7WUFDdEIsYUFBYSxFQUFFO2dCQUNi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Q0FBQztLQUMvQixDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2xvdWR3YXRjaCBmcm9tICdAYXdzLWNkay9hd3MtY2xvdWR3YXRjaCc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnQGF3cy1jZGsvYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnQGF3cy1jZGsvYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBraW5lc2lzIGZyb20gJ0Bhd3MtY2RrL2F3cy1raW5lc2lzJztcbmltcG9ydCAqIGFzIGttcyBmcm9tICdAYXdzLWNkay9hd3Mta21zJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCB7IFJlZ2lvbkluZm8gfSBmcm9tICdAYXdzLWNkay9yZWdpb24taW5mbyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QsIE5vZGUgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IElEZXN0aW5hdGlvbiB9IGZyb20gJy4vZGVzdGluYXRpb24nO1xuaW1wb3J0IHsgRmlyZWhvc2VNZXRyaWNzIH0gZnJvbSAnLi9raW5lc2lzZmlyZWhvc2UtY2FubmVkLW1ldHJpY3MuZ2VuZXJhdGVkJztcbmltcG9ydCB7IENmbkRlbGl2ZXJ5U3RyZWFtIH0gZnJvbSAnLi9raW5lc2lzZmlyZWhvc2UuZ2VuZXJhdGVkJztcblxuY29uc3QgUFVUX1JFQ09SRF9BQ1RJT05TID0gW1xuICAnZmlyZWhvc2U6UHV0UmVjb3JkJyxcbiAgJ2ZpcmVob3NlOlB1dFJlY29yZEJhdGNoJyxcbl07XG5cbi8qKlxuICogUmVwcmVzZW50cyBhIEtpbmVzaXMgRGF0YSBGaXJlaG9zZSBkZWxpdmVyeSBzdHJlYW0uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSURlbGl2ZXJ5U3RyZWFtIGV4dGVuZHMgY2RrLklSZXNvdXJjZSwgaWFtLklHcmFudGFibGUsIGVjMi5JQ29ubmVjdGFibGUge1xuICAvKipcbiAgICogVGhlIEFSTiBvZiB0aGUgZGVsaXZlcnkgc3RyZWFtLlxuICAgKlxuICAgKiBAYXR0cmlidXRlXG4gICAqL1xuICByZWFkb25seSBkZWxpdmVyeVN0cmVhbUFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgZGVsaXZlcnkgc3RyZWFtLlxuICAgKlxuICAgKiBAYXR0cmlidXRlXG4gICAqL1xuICByZWFkb25seSBkZWxpdmVyeVN0cmVhbU5hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogR3JhbnQgdGhlIGBncmFudGVlYCBpZGVudGl0eSBwZXJtaXNzaW9ucyB0byBwZXJmb3JtIGBhY3Rpb25zYC5cbiAgICovXG4gIGdyYW50KGdyYW50ZWU6IGlhbS5JR3JhbnRhYmxlLCAuLi5hY3Rpb25zOiBzdHJpbmdbXSk6IGlhbS5HcmFudDtcblxuICAvKipcbiAgICogR3JhbnQgdGhlIGBncmFudGVlYCBpZGVudGl0eSBwZXJtaXNzaW9ucyB0byBwZXJmb3JtIGBmaXJlaG9zZTpQdXRSZWNvcmRgIGFuZCBgZmlyZWhvc2U6UHV0UmVjb3JkQmF0Y2hgIGFjdGlvbnMgb24gdGhpcyBkZWxpdmVyeSBzdHJlYW0uXG4gICAqL1xuICBncmFudFB1dFJlY29yZHMoZ3JhbnRlZTogaWFtLklHcmFudGFibGUpOiBpYW0uR3JhbnQ7XG5cbiAgLyoqXG4gICAqIFJldHVybiB0aGUgZ2l2ZW4gbmFtZWQgbWV0cmljIGZvciB0aGlzIGRlbGl2ZXJ5IHN0cmVhbS5cbiAgICovXG4gIG1ldHJpYyhtZXRyaWNOYW1lOiBzdHJpbmcsIHByb3BzPzogY2xvdWR3YXRjaC5NZXRyaWNPcHRpb25zKTogY2xvdWR3YXRjaC5NZXRyaWM7XG5cbiAgLyoqXG4gICAqIE1ldHJpYyBmb3IgdGhlIG51bWJlciBvZiBieXRlcyBpbmdlc3RlZCBzdWNjZXNzZnVsbHkgaW50byB0aGUgZGVsaXZlcnkgc3RyZWFtIG92ZXIgdGhlIHNwZWNpZmllZCB0aW1lIHBlcmlvZCBhZnRlciB0aHJvdHRsaW5nLlxuICAgKlxuICAgKiBCeSBkZWZhdWx0LCB0aGlzIG1ldHJpYyB3aWxsIGJlIGNhbGN1bGF0ZWQgYXMgYW4gYXZlcmFnZSBvdmVyIGEgcGVyaW9kIG9mIDUgbWludXRlcy5cbiAgICovXG4gIG1ldHJpY0luY29taW5nQnl0ZXMocHJvcHM/OiBjbG91ZHdhdGNoLk1ldHJpY09wdGlvbnMpOiBjbG91ZHdhdGNoLk1ldHJpYztcblxuICAvKipcbiAgICogTWV0cmljIGZvciB0aGUgbnVtYmVyIG9mIHJlY29yZHMgaW5nZXN0ZWQgc3VjY2Vzc2Z1bGx5IGludG8gdGhlIGRlbGl2ZXJ5IHN0cmVhbSBvdmVyIHRoZSBzcGVjaWZpZWQgdGltZSBwZXJpb2QgYWZ0ZXIgdGhyb3R0bGluZy5cbiAgICpcbiAgICogQnkgZGVmYXVsdCwgdGhpcyBtZXRyaWMgd2lsbCBiZSBjYWxjdWxhdGVkIGFzIGFuIGF2ZXJhZ2Ugb3ZlciBhIHBlcmlvZCBvZiA1IG1pbnV0ZXMuXG4gICAqL1xuICBtZXRyaWNJbmNvbWluZ1JlY29yZHMocHJvcHM/OiBjbG91ZHdhdGNoLk1ldHJpY09wdGlvbnMpOiBjbG91ZHdhdGNoLk1ldHJpYztcblxuICAvKipcbiAgICogTWV0cmljIGZvciB0aGUgbnVtYmVyIG9mIGJ5dGVzIGRlbGl2ZXJlZCB0byBBbWF6b24gUzMgZm9yIGJhY2t1cCBvdmVyIHRoZSBzcGVjaWZpZWQgdGltZSBwZXJpb2QuXG4gICAqXG4gICAqIEJ5IGRlZmF1bHQsIHRoaXMgbWV0cmljIHdpbGwgYmUgY2FsY3VsYXRlZCBhcyBhbiBhdmVyYWdlIG92ZXIgYSBwZXJpb2Qgb2YgNSBtaW51dGVzLlxuICAgKi9cbiAgbWV0cmljQmFja3VwVG9TM0J5dGVzKHByb3BzPzogY2xvdWR3YXRjaC5NZXRyaWNPcHRpb25zKTogY2xvdWR3YXRjaC5NZXRyaWM7XG5cbiAgLyoqXG4gICAqIE1ldHJpYyBmb3IgdGhlIGFnZSAoZnJvbSBnZXR0aW5nIGludG8gS2luZXNpcyBEYXRhIEZpcmVob3NlIHRvIG5vdykgb2YgdGhlIG9sZGVzdCByZWNvcmQgaW4gS2luZXNpcyBEYXRhIEZpcmVob3NlLlxuICAgKlxuICAgKiBBbnkgcmVjb3JkIG9sZGVyIHRoYW4gdGhpcyBhZ2UgaGFzIGJlZW4gZGVsaXZlcmVkIHRvIHRoZSBBbWF6b24gUzMgYnVja2V0IGZvciBiYWNrdXAuXG4gICAqXG4gICAqIEJ5IGRlZmF1bHQsIHRoaXMgbWV0cmljIHdpbGwgYmUgY2FsY3VsYXRlZCBhcyBhbiBhdmVyYWdlIG92ZXIgYSBwZXJpb2Qgb2YgNSBtaW51dGVzLlxuICAgKi9cbiAgbWV0cmljQmFja3VwVG9TM0RhdGFGcmVzaG5lc3MocHJvcHM/OiBjbG91ZHdhdGNoLk1ldHJpY09wdGlvbnMpOiBjbG91ZHdhdGNoLk1ldHJpYztcblxuICAvKipcbiAgICogTWV0cmljIGZvciB0aGUgbnVtYmVyIG9mIHJlY29yZHMgZGVsaXZlcmVkIHRvIEFtYXpvbiBTMyBmb3IgYmFja3VwIG92ZXIgdGhlIHNwZWNpZmllZCB0aW1lIHBlcmlvZC5cbiAgICpcbiAgICogQnkgZGVmYXVsdCwgdGhpcyBtZXRyaWMgd2lsbCBiZSBjYWxjdWxhdGVkIGFzIGFuIGF2ZXJhZ2Ugb3ZlciBhIHBlcmlvZCBvZiA1IG1pbnV0ZXMuXG4gICAqL1xuICBtZXRyaWNCYWNrdXBUb1MzUmVjb3Jkcyhwcm9wcz86IGNsb3Vkd2F0Y2guTWV0cmljT3B0aW9ucyk6IGNsb3Vkd2F0Y2guTWV0cmljO1xufVxuXG4vKipcbiAqIEJhc2UgY2xhc3MgZm9yIG5ldyBhbmQgaW1wb3J0ZWQgS2luZXNpcyBEYXRhIEZpcmVob3NlIGRlbGl2ZXJ5IHN0cmVhbXMuXG4gKi9cbmFic3RyYWN0IGNsYXNzIERlbGl2ZXJ5U3RyZWFtQmFzZSBleHRlbmRzIGNkay5SZXNvdXJjZSBpbXBsZW1lbnRzIElEZWxpdmVyeVN0cmVhbSB7XG5cbiAgcHVibGljIGFic3RyYWN0IHJlYWRvbmx5IGRlbGl2ZXJ5U3RyZWFtTmFtZTogc3RyaW5nO1xuXG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSBkZWxpdmVyeVN0cmVhbUFybjogc3RyaW5nO1xuXG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSBncmFudFByaW5jaXBhbDogaWFtLklQcmluY2lwYWw7XG5cbiAgLyoqXG4gICAqIE5ldHdvcmsgY29ubmVjdGlvbnMgYmV0d2VlbiBLaW5lc2lzIERhdGEgRmlyZWhvc2UgYW5kIG90aGVyIHJlc291cmNlcywgaS5lLiBSZWRzaGlmdCBjbHVzdGVyLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGNvbm5lY3Rpb25zOiBlYzIuQ29ubmVjdGlvbnM7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IGNkay5SZXNvdXJjZVByb3BzID0ge30pIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIHRoaXMuY29ubmVjdGlvbnMgPSBzZXRDb25uZWN0aW9ucyh0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBncmFudChncmFudGVlOiBpYW0uSUdyYW50YWJsZSwgLi4uYWN0aW9uczogc3RyaW5nW10pOiBpYW0uR3JhbnQge1xuICAgIHJldHVybiBpYW0uR3JhbnQuYWRkVG9QcmluY2lwYWwoe1xuICAgICAgcmVzb3VyY2VBcm5zOiBbdGhpcy5kZWxpdmVyeVN0cmVhbUFybl0sXG4gICAgICBncmFudGVlOiBncmFudGVlLFxuICAgICAgYWN0aW9uczogYWN0aW9ucyxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBncmFudFB1dFJlY29yZHMoZ3JhbnRlZTogaWFtLklHcmFudGFibGUpOiBpYW0uR3JhbnQge1xuICAgIHJldHVybiB0aGlzLmdyYW50KGdyYW50ZWUsIC4uLlBVVF9SRUNPUkRfQUNUSU9OUyk7XG4gIH1cblxuICBwdWJsaWMgbWV0cmljKG1ldHJpY05hbWU6IHN0cmluZywgcHJvcHM/OiBjbG91ZHdhdGNoLk1ldHJpY09wdGlvbnMpOiBjbG91ZHdhdGNoLk1ldHJpYyB7XG4gICAgcmV0dXJuIG5ldyBjbG91ZHdhdGNoLk1ldHJpYyh7XG4gICAgICBuYW1lc3BhY2U6ICdBV1MvRmlyZWhvc2UnLFxuICAgICAgbWV0cmljTmFtZTogbWV0cmljTmFtZSxcbiAgICAgIGRpbWVuc2lvbnNNYXA6IHtcbiAgICAgICAgRGVsaXZlcnlTdHJlYW1OYW1lOiB0aGlzLmRlbGl2ZXJ5U3RyZWFtTmFtZSxcbiAgICAgIH0sXG4gICAgICAuLi5wcm9wcyxcbiAgICB9KS5hdHRhY2hUbyh0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBtZXRyaWNJbmNvbWluZ0J5dGVzKHByb3BzPzogY2xvdWR3YXRjaC5NZXRyaWNPcHRpb25zKTogY2xvdWR3YXRjaC5NZXRyaWMge1xuICAgIHJldHVybiB0aGlzLmNhbm5lZE1ldHJpYyhGaXJlaG9zZU1ldHJpY3MuaW5jb21pbmdCeXRlc1N1bSwgcHJvcHMpO1xuICB9XG5cbiAgcHVibGljIG1ldHJpY0luY29taW5nUmVjb3Jkcyhwcm9wcz86IGNsb3Vkd2F0Y2guTWV0cmljT3B0aW9ucyk6IGNsb3Vkd2F0Y2guTWV0cmljIHtcbiAgICByZXR1cm4gdGhpcy5jYW5uZWRNZXRyaWMoRmlyZWhvc2VNZXRyaWNzLmluY29taW5nUmVjb3Jkc1N1bSwgcHJvcHMpO1xuICB9XG5cbiAgcHVibGljIG1ldHJpY0JhY2t1cFRvUzNCeXRlcyhwcm9wcz86IGNsb3Vkd2F0Y2guTWV0cmljT3B0aW9ucyk6IGNsb3Vkd2F0Y2guTWV0cmljIHtcbiAgICByZXR1cm4gdGhpcy5jYW5uZWRNZXRyaWMoRmlyZWhvc2VNZXRyaWNzLmJhY2t1cFRvUzNCeXRlc1N1bSwgcHJvcHMpO1xuICB9XG5cbiAgcHVibGljIG1ldHJpY0JhY2t1cFRvUzNEYXRhRnJlc2huZXNzKHByb3BzPzogY2xvdWR3YXRjaC5NZXRyaWNPcHRpb25zKTogY2xvdWR3YXRjaC5NZXRyaWMge1xuICAgIHJldHVybiB0aGlzLmNhbm5lZE1ldHJpYyhGaXJlaG9zZU1ldHJpY3MuYmFja3VwVG9TM0RhdGFGcmVzaG5lc3NBdmVyYWdlLCBwcm9wcyk7XG4gIH1cblxuICBwdWJsaWMgbWV0cmljQmFja3VwVG9TM1JlY29yZHMocHJvcHM/OiBjbG91ZHdhdGNoLk1ldHJpY09wdGlvbnMpOiBjbG91ZHdhdGNoLk1ldHJpYyB7XG4gICAgcmV0dXJuIHRoaXMuY2FubmVkTWV0cmljKEZpcmVob3NlTWV0cmljcy5iYWNrdXBUb1MzUmVjb3Jkc1N1bSwgcHJvcHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBjYW5uZWRNZXRyaWMoZm46IChkaW1zOiB7IERlbGl2ZXJ5U3RyZWFtTmFtZTogc3RyaW5nIH0pID0+IGNsb3Vkd2F0Y2guTWV0cmljUHJvcHMsIHByb3BzPzogY2xvdWR3YXRjaC5NZXRyaWNPcHRpb25zKTogY2xvdWR3YXRjaC5NZXRyaWMge1xuICAgIHJldHVybiBuZXcgY2xvdWR3YXRjaC5NZXRyaWMoe1xuICAgICAgLi4uZm4oeyBEZWxpdmVyeVN0cmVhbU5hbWU6IHRoaXMuZGVsaXZlcnlTdHJlYW1OYW1lIH0pLFxuICAgICAgLi4ucHJvcHMsXG4gICAgfSkuYXR0YWNoVG8odGhpcyk7XG4gIH1cbn1cblxuLyoqXG4gKiBPcHRpb25zIGZvciBzZXJ2ZXItc2lkZSBlbmNyeXB0aW9uIG9mIGEgZGVsaXZlcnkgc3RyZWFtLlxuICovXG5leHBvcnQgZW51bSBTdHJlYW1FbmNyeXB0aW9uIHtcbiAgLyoqXG4gICAqIERhdGEgaW4gdGhlIHN0cmVhbSBpcyBzdG9yZWQgdW5lbmNyeXB0ZWQuXG4gICAqL1xuICBVTkVOQ1JZUFRFRCxcblxuICAvKipcbiAgICogRGF0YSBpbiB0aGUgc3RyZWFtIGlzIHN0b3JlZCBlbmNyeXB0ZWQgYnkgYSBLTVMga2V5IG1hbmFnZWQgYnkgdGhlIGN1c3RvbWVyLlxuICAgKi9cbiAgQ1VTVE9NRVJfTUFOQUdFRCxcblxuICAvKipcbiAgICogRGF0YSBpbiB0aGUgc3RyZWFtIGlzIHN0b3JlZCBlbmNyeXB0ZWQgYnkgYSBLTVMga2V5IG93bmVkIGJ5IEFXUyBhbmQgbWFuYWdlZCBmb3IgdXNlIGluIG11bHRpcGxlIEFXUyBhY2NvdW50cy5cbiAgICovXG4gIEFXU19PV05FRCxcbn1cblxuLyoqXG4gKiBQcm9wZXJ0aWVzIGZvciBhIG5ldyBkZWxpdmVyeSBzdHJlYW0uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRGVsaXZlcnlTdHJlYW1Qcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgZGVzdGluYXRpb25zIHRoYXQgdGhpcyBkZWxpdmVyeSBzdHJlYW0gd2lsbCBkZWxpdmVyIGRhdGEgdG8uXG4gICAqXG4gICAqIE9ubHkgYSBzaW5nbGV0b24gYXJyYXkgaXMgc3VwcG9ydGVkIGF0IHRoaXMgdGltZS5cbiAgICovXG4gIHJlYWRvbmx5IGRlc3RpbmF0aW9uczogSURlc3RpbmF0aW9uW107XG5cbiAgLyoqXG4gICAqIEEgbmFtZSBmb3IgdGhlIGRlbGl2ZXJ5IHN0cmVhbS5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBhIG5hbWUgaXMgZ2VuZXJhdGVkIGJ5IENsb3VkRm9ybWF0aW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgZGVsaXZlcnlTdHJlYW1OYW1lPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgS2luZXNpcyBkYXRhIHN0cmVhbSB0byB1c2UgYXMgYSBzb3VyY2UgZm9yIHRoaXMgZGVsaXZlcnkgc3RyZWFtLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIGRhdGEgbXVzdCBiZSB3cml0dGVuIHRvIHRoZSBkZWxpdmVyeSBzdHJlYW0gdmlhIGEgZGlyZWN0IHB1dC5cbiAgICovXG4gIHJlYWRvbmx5IHNvdXJjZVN0cmVhbT86IGtpbmVzaXMuSVN0cmVhbTtcblxuICAvKipcbiAgICogVGhlIElBTSByb2xlIGFzc29jaWF0ZWQgd2l0aCB0aGlzIGRlbGl2ZXJ5IHN0cmVhbS5cbiAgICpcbiAgICogQXNzdW1lZCBieSBLaW5lc2lzIERhdGEgRmlyZWhvc2UgdG8gcmVhZCBmcm9tIHNvdXJjZXMgYW5kIGVuY3J5cHQgZGF0YSBzZXJ2ZXItc2lkZS5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBhIHJvbGUgd2lsbCBiZSBjcmVhdGVkIHdpdGggZGVmYXVsdCBwZXJtaXNzaW9ucy5cbiAgICovXG4gIHJlYWRvbmx5IHJvbGU/OiBpYW0uSVJvbGU7XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGUgdHlwZSBvZiBjdXN0b21lciBtYXN0ZXIga2V5IChDTUspIHRvIHVzZSBmb3Igc2VydmVyLXNpZGUgZW5jcnlwdGlvbiwgaWYgYW55LlxuICAgKlxuICAgKiBAZGVmYXVsdCBTdHJlYW1FbmNyeXB0aW9uLlVORU5DUllQVEVEIC0gdW5sZXNzIGBlbmNyeXB0aW9uS2V5YCBpcyBwcm92aWRlZCwgaW4gd2hpY2ggY2FzZSB0aGlzIHdpbGwgYmUgaW1wbGljaXRseSBzZXQgdG8gYFN0cmVhbUVuY3J5cHRpb24uQ1VTVE9NRVJfTUFOQUdFRGBcbiAgICovXG4gIHJlYWRvbmx5IGVuY3J5cHRpb24/OiBTdHJlYW1FbmNyeXB0aW9uO1xuXG4gIC8qKlxuICAgKiBDdXN0b21lciBtYW5hZ2VkIGtleSB0byBzZXJ2ZXItc2lkZSBlbmNyeXB0IGRhdGEgaW4gdGhlIHN0cmVhbS5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBubyBLTVMga2V5IHdpbGwgYmUgdXNlZDsgaWYgYGVuY3J5cHRpb25gIGlzIHNldCB0byBgQ1VTVE9NRVJfTUFOQUdFRGAsIGEgS01TIGtleSB3aWxsIGJlIGNyZWF0ZWQgZm9yIHlvdVxuICAgKi9cbiAgcmVhZG9ubHkgZW5jcnlwdGlvbktleT86IGttcy5JS2V5O1xufVxuXG4vKipcbiAqIEEgZnVsbCBzcGVjaWZpY2F0aW9uIG9mIGEgZGVsaXZlcnkgc3RyZWFtIHRoYXQgY2FuIGJlIHVzZWQgdG8gaW1wb3J0IGl0IGZsdWVudGx5IGludG8gdGhlIENESyBhcHBsaWNhdGlvbi5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBEZWxpdmVyeVN0cmVhbUF0dHJpYnV0ZXMge1xuICAvKipcbiAgICogVGhlIEFSTiBvZiB0aGUgZGVsaXZlcnkgc3RyZWFtLlxuICAgKlxuICAgKiBBdCBsZWFzdCBvbmUgb2YgZGVsaXZlcnlTdHJlYW1Bcm4gYW5kIGRlbGl2ZXJ5U3RyZWFtTmFtZSBtdXN0IGJlIHByb3ZpZGVkLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIGRlcml2ZWQgZnJvbSBgZGVsaXZlcnlTdHJlYW1OYW1lYC5cbiAgICovXG4gIHJlYWRvbmx5IGRlbGl2ZXJ5U3RyZWFtQXJuPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgZGVsaXZlcnkgc3RyZWFtXG4gICAqXG4gICAqIEF0IGxlYXN0IG9uZSBvZiBkZWxpdmVyeVN0cmVhbU5hbWUgYW5kIGRlbGl2ZXJ5U3RyZWFtQXJuICBtdXN0IGJlIHByb3ZpZGVkLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIGRlcml2ZWQgZnJvbSBgZGVsaXZlcnlTdHJlYW1Bcm5gLlxuICAgKi9cbiAgcmVhZG9ubHkgZGVsaXZlcnlTdHJlYW1OYW1lPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgSUFNIHJvbGUgYXNzb2NpYXRlZCB3aXRoIHRoaXMgZGVsaXZlcnkgc3RyZWFtLlxuICAgKlxuICAgKiBBc3N1bWVkIGJ5IEtpbmVzaXMgRGF0YSBGaXJlaG9zZSB0byByZWFkIGZyb20gc291cmNlcyBhbmQgZW5jcnlwdCBkYXRhIHNlcnZlci1zaWRlLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIHRoZSBpbXBvcnRlZCBzdHJlYW0gY2Fubm90IGJlIGdyYW50ZWQgYWNjZXNzIHRvIG90aGVyIHJlc291cmNlcyBhcyBhbiBgaWFtLklHcmFudGFibGVgLlxuICAgKi9cbiAgcmVhZG9ubHkgcm9sZT86IGlhbS5JUm9sZTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYSBLaW5lc2lzIERhdGEgRmlyZWhvc2UgZGVsaXZlcnkgc3RyZWFtXG4gKlxuICogQHJlc291cmNlIEFXUzo6S2luZXNpc0ZpcmVob3NlOjpEZWxpdmVyeVN0cmVhbVxuICovXG5leHBvcnQgY2xhc3MgRGVsaXZlcnlTdHJlYW0gZXh0ZW5kcyBEZWxpdmVyeVN0cmVhbUJhc2Uge1xuICAvKipcbiAgICogSW1wb3J0IGFuIGV4aXN0aW5nIGRlbGl2ZXJ5IHN0cmVhbSBmcm9tIGl0cyBuYW1lLlxuICAgKi9cbiAgc3RhdGljIGZyb21EZWxpdmVyeVN0cmVhbU5hbWUoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgZGVsaXZlcnlTdHJlYW1OYW1lOiBzdHJpbmcpOiBJRGVsaXZlcnlTdHJlYW0ge1xuICAgIHJldHVybiB0aGlzLmZyb21EZWxpdmVyeVN0cmVhbUF0dHJpYnV0ZXMoc2NvcGUsIGlkLCB7IGRlbGl2ZXJ5U3RyZWFtTmFtZSB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbXBvcnQgYW4gZXhpc3RpbmcgZGVsaXZlcnkgc3RyZWFtIGZyb20gaXRzIEFSTi5cbiAgICovXG4gIHN0YXRpYyBmcm9tRGVsaXZlcnlTdHJlYW1Bcm4oc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgZGVsaXZlcnlTdHJlYW1Bcm46IHN0cmluZyk6IElEZWxpdmVyeVN0cmVhbSB7XG4gICAgcmV0dXJuIHRoaXMuZnJvbURlbGl2ZXJ5U3RyZWFtQXR0cmlidXRlcyhzY29wZSwgaWQsIHsgZGVsaXZlcnlTdHJlYW1Bcm4gfSk7XG4gIH1cblxuICAvKipcbiAgICogSW1wb3J0IGFuIGV4aXN0aW5nIGRlbGl2ZXJ5IHN0cmVhbSBmcm9tIGl0cyBhdHRyaWJ1dGVzLlxuICAgKi9cbiAgc3RhdGljIGZyb21EZWxpdmVyeVN0cmVhbUF0dHJpYnV0ZXMoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgYXR0cnM6IERlbGl2ZXJ5U3RyZWFtQXR0cmlidXRlcyk6IElEZWxpdmVyeVN0cmVhbSB7XG4gICAgaWYgKCFhdHRycy5kZWxpdmVyeVN0cmVhbU5hbWUgJiYgIWF0dHJzLmRlbGl2ZXJ5U3RyZWFtQXJuKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VpdGhlciBkZWxpdmVyeVN0cmVhbU5hbWUgb3IgZGVsaXZlcnlTdHJlYW1Bcm4gbXVzdCBiZSBwcm92aWRlZCBpbiBEZWxpdmVyeVN0cmVhbUF0dHJpYnV0ZXMnKTtcbiAgICB9XG4gICAgY29uc3QgZGVsaXZlcnlTdHJlYW1OYW1lID0gYXR0cnMuZGVsaXZlcnlTdHJlYW1OYW1lID8/XG4gICAgICBjZGsuU3RhY2sub2Yoc2NvcGUpLnNwbGl0QXJuKGF0dHJzLmRlbGl2ZXJ5U3RyZWFtQXJuISwgY2RrLkFybkZvcm1hdC5TTEFTSF9SRVNPVVJDRV9OQU1FKS5yZXNvdXJjZU5hbWU7XG5cbiAgICBpZiAoIWRlbGl2ZXJ5U3RyZWFtTmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBkZWxpdmVyeSBzdHJlYW0gbmFtZSBmb3VuZCBpbiBBUk46ICcke2F0dHJzLmRlbGl2ZXJ5U3RyZWFtQXJufSdgKTtcbiAgICB9XG4gICAgY29uc3QgZGVsaXZlcnlTdHJlYW1Bcm4gPSBhdHRycy5kZWxpdmVyeVN0cmVhbUFybiA/PyBjZGsuU3RhY2sub2Yoc2NvcGUpLmZvcm1hdEFybih7XG4gICAgICBzZXJ2aWNlOiAnZmlyZWhvc2UnLFxuICAgICAgcmVzb3VyY2U6ICdkZWxpdmVyeXN0cmVhbScsXG4gICAgICByZXNvdXJjZU5hbWU6IGF0dHJzLmRlbGl2ZXJ5U3RyZWFtTmFtZSxcbiAgICAgIGFybkZvcm1hdDogY2RrLkFybkZvcm1hdC5TTEFTSF9SRVNPVVJDRV9OQU1FLFxuICAgIH0pO1xuICAgIGNsYXNzIEltcG9ydCBleHRlbmRzIERlbGl2ZXJ5U3RyZWFtQmFzZSB7XG4gICAgICBwdWJsaWMgcmVhZG9ubHkgZGVsaXZlcnlTdHJlYW1OYW1lID0gZGVsaXZlcnlTdHJlYW1OYW1lITtcbiAgICAgIHB1YmxpYyByZWFkb25seSBkZWxpdmVyeVN0cmVhbUFybiA9IGRlbGl2ZXJ5U3RyZWFtQXJuO1xuICAgICAgcHVibGljIHJlYWRvbmx5IGdyYW50UHJpbmNpcGFsID0gYXR0cnMucm9sZSA/PyBuZXcgaWFtLlVua25vd25QcmluY2lwYWwoeyByZXNvdXJjZTogdGhpcyB9KTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBJbXBvcnQoc2NvcGUsIGlkKTtcbiAgfVxuXG4gIHJlYWRvbmx5IGRlbGl2ZXJ5U3RyZWFtTmFtZTogc3RyaW5nO1xuXG4gIHJlYWRvbmx5IGRlbGl2ZXJ5U3RyZWFtQXJuOiBzdHJpbmc7XG5cbiAgcmVhZG9ubHkgZ3JhbnRQcmluY2lwYWw6IGlhbS5JUHJpbmNpcGFsO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBEZWxpdmVyeVN0cmVhbVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCB7XG4gICAgICBwaHlzaWNhbE5hbWU6IHByb3BzLmRlbGl2ZXJ5U3RyZWFtTmFtZSxcbiAgICB9KTtcblxuICAgIGlmIChwcm9wcy5kZXN0aW5hdGlvbnMubGVuZ3RoICE9PSAxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE9ubHkgb25lIGRlc3RpbmF0aW9uIGlzIGFsbG93ZWQgcGVyIGRlbGl2ZXJ5IHN0cmVhbSwgZ2l2ZW4gJHtwcm9wcy5kZXN0aW5hdGlvbnMubGVuZ3RofWApO1xuICAgIH1cblxuICAgIGNvbnN0IHJvbGUgPSBwcm9wcy5yb2xlID8/IG5ldyBpYW0uUm9sZSh0aGlzLCAnU2VydmljZSBSb2xlJywge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ2ZpcmVob3NlLmFtYXpvbmF3cy5jb20nKSxcbiAgICB9KTtcbiAgICB0aGlzLmdyYW50UHJpbmNpcGFsID0gcm9sZTtcblxuICAgIGlmIChcbiAgICAgIHByb3BzLnNvdXJjZVN0cmVhbSAmJlxuICAgICAgICAocHJvcHMuZW5jcnlwdGlvbiA9PT0gU3RyZWFtRW5jcnlwdGlvbi5BV1NfT1dORUQgfHwgcHJvcHMuZW5jcnlwdGlvbiA9PT0gU3RyZWFtRW5jcnlwdGlvbi5DVVNUT01FUl9NQU5BR0VEIHx8IHByb3BzLmVuY3J5cHRpb25LZXkpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3RlZCBzZXJ2ZXItc2lkZSBlbmNyeXB0aW9uIGJ1dCBkZWxpdmVyeSBzdHJlYW0gc291cmNlIGlzIGEgS2luZXNpcyBkYXRhIHN0cmVhbS4gU3BlY2lmeSBzZXJ2ZXItc2lkZSBlbmNyeXB0aW9uIG9uIHRoZSBkYXRhIHN0cmVhbSBpbnN0ZWFkLicpO1xuICAgIH1cbiAgICBpZiAoKHByb3BzLmVuY3J5cHRpb24gPT09IFN0cmVhbUVuY3J5cHRpb24uQVdTX09XTkVEIHx8IHByb3BzLmVuY3J5cHRpb24gPT09IFN0cmVhbUVuY3J5cHRpb24uVU5FTkNSWVBURUQpICYmIHByb3BzLmVuY3J5cHRpb25LZXkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgU3BlY2lmaWVkIHN0cmVhbSBlbmNyeXB0aW9uIGFzICR7U3RyZWFtRW5jcnlwdGlvbltwcm9wcy5lbmNyeXB0aW9uXX0gYnV0IHByb3ZpZGVkIGEgY3VzdG9tZXItbWFuYWdlZCBrZXlgKTtcbiAgICB9XG4gICAgY29uc3QgZW5jcnlwdGlvbktleSA9IHByb3BzLmVuY3J5cHRpb25LZXkgPz8gKHByb3BzLmVuY3J5cHRpb24gPT09IFN0cmVhbUVuY3J5cHRpb24uQ1VTVE9NRVJfTUFOQUdFRCA/IG5ldyBrbXMuS2V5KHRoaXMsICdLZXknKSA6IHVuZGVmaW5lZCk7XG4gICAgY29uc3QgZW5jcnlwdGlvbkNvbmZpZyA9IChlbmNyeXB0aW9uS2V5IHx8IChwcm9wcy5lbmNyeXB0aW9uID09PSBTdHJlYW1FbmNyeXB0aW9uLkFXU19PV05FRCkpID8ge1xuICAgICAga2V5QXJuOiBlbmNyeXB0aW9uS2V5Py5rZXlBcm4sXG4gICAgICBrZXlUeXBlOiBlbmNyeXB0aW9uS2V5ID8gJ0NVU1RPTUVSX01BTkFHRURfQ01LJyA6ICdBV1NfT1dORURfQ01LJyxcbiAgICB9IDogdW5kZWZpbmVkO1xuICAgIC8qXG4gICAgICogSW4gb3JkZXIgZm9yIHRoZSBzZXJ2aWNlIHJvbGUgdG8gaGF2ZSBhY2Nlc3MgdG8gdGhlIGVuY3J5cHRpb24ga2V5IGJlZm9yZSB0aGUgZGVsaXZlcnkgc3RyZWFtIGlzIGNyZWF0ZWQsIHRoZVxuICAgICAqIENmbkRlbGl2ZXJ5U3RyZWFtIGJlbG93IHNob3VsZCBoYXZlIGEgZGVwZW5kZW5jeSBvbiB0aGUgZ3JhbnQgcmV0dXJuZWQgYnkgdGhlIGZ1bmN0aW9uIGNhbGwgYmVsb3c6XG4gICAgICogPiBga2V5R3JhbnQ/LmFwcGx5QmVmb3JlKHJlc291cmNlKWBcbiAgICAgKiBIb3dldmVyLCBhbiBlcnJvciBkdXJpbmcgc3ludGhlc2lzIGlzIHRocm93biBpZiB0aGlzIGlzIGFkZGVkOlxuICAgICAqID4gJHtUb2tlbltQb2xpY3lEb2N1bWVudC4jIyNdfSBkb2VzIG5vdCBpbXBsZW1lbnQgRGVwZW5kYWJsZVRyYWl0XG4gICAgICogRGF0YSB3aWxsIG5vdCBiZSBsb3N0IGlmIHRoZSBwZXJtaXNzaW9ucyBhcmUgbm90IGdyYW50ZWQgdG8gdGhlIHNlcnZpY2Ugcm9sZSBpbW1lZGlhdGVseTsgRmlyZWhvc2UgaGFzIGEgMjQgaG91clxuICAgICAqIHBlcmlvZCB3aGVyZSBkYXRhIHdpbGwgYmUgYnVmZmVyZWQgYW5kIHJldHJpZWQgaWYgYWNjZXNzIGlzIGRlbmllZCB0byB0aGUgZW5jcnlwdGlvbiBrZXkuIEZvciB0aGF0IHJlYXNvbiwgaXQgaXNcbiAgICAgKiBhY2NlcHRhYmxlIHRvIG9taXQgdGhlIGRlcGVuZGVuY3kgZm9yIG5vdy4gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vYXdzL2F3cy1jZGsvaXNzdWVzLzE1NzkwXG4gICAgICovXG4gICAgZW5jcnlwdGlvbktleT8uZ3JhbnRFbmNyeXB0RGVjcnlwdChyb2xlKTtcblxuICAgIGNvbnN0IHNvdXJjZVN0cmVhbUNvbmZpZyA9IHByb3BzLnNvdXJjZVN0cmVhbSA/IHtcbiAgICAgIGtpbmVzaXNTdHJlYW1Bcm46IHByb3BzLnNvdXJjZVN0cmVhbS5zdHJlYW1Bcm4sXG4gICAgICByb2xlQXJuOiByb2xlLnJvbGVBcm4sXG4gICAgfSA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCByZWFkU3RyZWFtR3JhbnQgPSBwcm9wcy5zb3VyY2VTdHJlYW0/LmdyYW50UmVhZChyb2xlKTtcblxuICAgIGNvbnN0IGRlc3RpbmF0aW9uQ29uZmlnID0gcHJvcHMuZGVzdGluYXRpb25zWzBdLmJpbmQodGhpcywge30pO1xuXG4gICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgQ2ZuRGVsaXZlcnlTdHJlYW0odGhpcywgJ1Jlc291cmNlJywge1xuICAgICAgZGVsaXZlcnlTdHJlYW1FbmNyeXB0aW9uQ29uZmlndXJhdGlvbklucHV0OiBlbmNyeXB0aW9uQ29uZmlnLFxuICAgICAgZGVsaXZlcnlTdHJlYW1OYW1lOiBwcm9wcy5kZWxpdmVyeVN0cmVhbU5hbWUsXG4gICAgICBkZWxpdmVyeVN0cmVhbVR5cGU6IHByb3BzLnNvdXJjZVN0cmVhbSA/ICdLaW5lc2lzU3RyZWFtQXNTb3VyY2UnIDogJ0RpcmVjdFB1dCcsXG4gICAgICBraW5lc2lzU3RyZWFtU291cmNlQ29uZmlndXJhdGlvbjogc291cmNlU3RyZWFtQ29uZmlnLFxuICAgICAgLi4uZGVzdGluYXRpb25Db25maWcsXG4gICAgfSk7XG5cbiAgICBkZXN0aW5hdGlvbkNvbmZpZy5kZXBlbmRhYmxlcz8uZm9yRWFjaChkZXBlbmRhYmxlID0+IHJlc291cmNlLm5vZGUuYWRkRGVwZW5kZW5jeShkZXBlbmRhYmxlKSk7XG4gICAgaWYgKHJlYWRTdHJlYW1HcmFudCkge1xuICAgICAgcmVzb3VyY2Uubm9kZS5hZGREZXBlbmRlbmN5KHJlYWRTdHJlYW1HcmFudCk7XG4gICAgfVxuXG4gICAgdGhpcy5kZWxpdmVyeVN0cmVhbUFybiA9IHRoaXMuZ2V0UmVzb3VyY2VBcm5BdHRyaWJ1dGUocmVzb3VyY2UuYXR0ckFybiwge1xuICAgICAgc2VydmljZTogJ2tpbmVzaXMnLFxuICAgICAgcmVzb3VyY2U6ICdkZWxpdmVyeXN0cmVhbScsXG4gICAgICByZXNvdXJjZU5hbWU6IHRoaXMucGh5c2ljYWxOYW1lLFxuICAgIH0pO1xuICAgIHRoaXMuZGVsaXZlcnlTdHJlYW1OYW1lID0gdGhpcy5nZXRSZXNvdXJjZU5hbWVBdHRyaWJ1dGUocmVzb3VyY2UucmVmKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzZXRDb25uZWN0aW9ucyhzY29wZTogQ29uc3RydWN0KSB7XG4gIGNvbnN0IHN0YWNrID0gY2RrLlN0YWNrLm9mKHNjb3BlKTtcblxuICBjb25zdCBtYXBwaW5nSWQgPSAnQGF3cy1jZGsvYXdzLWtpbmVzaXNmaXJlaG9zZS5DaWRyQmxvY2tzJztcbiAgbGV0IGNmbk1hcHBpbmcgPSBOb2RlLm9mKHN0YWNrKS50cnlGaW5kQ2hpbGQobWFwcGluZ0lkKSBhcyBjZGsuQ2ZuTWFwcGluZztcblxuICBpZiAoIWNmbk1hcHBpbmcpIHtcbiAgICBjb25zdCBtYXBwaW5nOiB7W3JlZ2lvbjogc3RyaW5nXTogeyBGaXJlaG9zZUNpZHJCbG9jazogc3RyaW5nIH19ID0ge307XG4gICAgUmVnaW9uSW5mby5yZWdpb25zLmZvckVhY2goKHJlZ2lvbkluZm8pID0+IHtcbiAgICAgIGlmIChyZWdpb25JbmZvLmZpcmVob3NlQ2lkckJsb2NrKSB7XG4gICAgICAgIG1hcHBpbmdbcmVnaW9uSW5mby5uYW1lXSA9IHtcbiAgICAgICAgICBGaXJlaG9zZUNpZHJCbG9jazogcmVnaW9uSW5mby5maXJlaG9zZUNpZHJCbG9jayxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBjZm5NYXBwaW5nID0gbmV3IGNkay5DZm5NYXBwaW5nKHN0YWNrLCBtYXBwaW5nSWQsIHtcbiAgICAgIG1hcHBpbmcsXG4gICAgICBsYXp5OiB0cnVlLFxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgY2lkckJsb2NrID0gY2ZuTWFwcGluZy5maW5kSW5NYXAoc3RhY2sucmVnaW9uLCAnRmlyZWhvc2VDaWRyQmxvY2snKTtcblxuICByZXR1cm4gbmV3IGVjMi5Db25uZWN0aW9ucyh7XG4gICAgcGVlcjogZWMyLlBlZXIuaXB2NChjaWRyQmxvY2spLFxuICB9KTtcbn1cbiJdfQ==
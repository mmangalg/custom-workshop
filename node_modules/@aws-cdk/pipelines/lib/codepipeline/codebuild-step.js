"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CodeBuildStep = void 0;
const jsiiDeprecationWarnings = require("../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const codebuild = require("@aws-cdk/aws-codebuild");
const blueprint_1 = require("../blueprint");
const buildspecs_1 = require("./private/buildspecs");
const outputs_1 = require("./private/outputs");
/**
 * Run a script as a CodeBuild Project
 *
 * The BuildSpec must be available inline--it cannot reference a file
 * on disk. If your current build instructions are in a file like
 * `buildspec.yml` in your repository, extract them to a script
 * (say, `build.sh`) and invoke that script as part of the build:
 *
 * ```ts
 * new pipelines.CodeBuildStep('Synth', {
 *   commands: ['./build.sh'],
 * });
 * ```
 */
class CodeBuildStep extends blueprint_1.ShellStep {
    constructor(id, props) {
        super(id, props);
        this.exportedVariables = new Set();
        this.exportedVarsRendered = false;
        try {
            jsiiDeprecationWarnings._aws_cdk_pipelines_CodeBuildStepProps(props);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.constructor);
            }
            throw error;
        }
        this.projectName = props.projectName;
        this.buildEnvironment = props.buildEnvironment;
        this._partialBuildSpec = props.partialBuildSpec;
        this.vpc = props.vpc;
        this.subnetSelection = props.subnetSelection;
        this.role = props.role;
        this.rolePolicyStatements = props.rolePolicyStatements;
        this.securityGroups = props.securityGroups;
        this.timeout = props.timeout;
    }
    /**
     * CodeBuild Project generated for the pipeline
     *
     * Will only be available after the pipeline has been built.
     */
    get project() {
        if (!this._project) {
            throw new Error('Call pipeline.buildPipeline() before reading this property');
        }
        return this._project;
    }
    /**
     * The CodeBuild Project's principal
     */
    get grantPrincipal() {
        return this.project.grantPrincipal;
    }
    /**
     * Additional configuration that can only be configured via BuildSpec
     *
     * Contains exported variables
     *
     * @default - Contains the exported variables
     */
    get partialBuildSpec() {
        this.exportedVarsRendered = true;
        const varsBuildSpec = this.exportedVariables.size > 0 ? codebuild.BuildSpec.fromObject({
            version: '0.2',
            env: {
                'exported-variables': Array.from(this.exportedVariables),
            },
        }) : undefined;
        return buildspecs_1.mergeBuildSpecs(varsBuildSpec, this._partialBuildSpec);
    }
    /**
     * Reference a CodePipeline variable defined by the CodeBuildStep.
     *
     * The variable must be set in the shell of the CodeBuild step when
     * it finishes its `post_build` phase.
     *
     * @param variableName the name of the variable for reference.
     * @example
     * // Access the output of one CodeBuildStep in another CodeBuildStep
     * declare const pipeline: pipelines.CodePipeline;
     *
     * const step1 = new pipelines.CodeBuildStep('Step1', {
     *   commands: ['export MY_VAR=hello'],
     * });
     *
     * const step2 = new pipelines.CodeBuildStep('Step2', {
     *   env: {
     *     IMPORTED_VAR: step1.exportedVariable('MY_VAR'),
     *   },
     *   commands: ['echo $IMPORTED_VAR'],
     * });
     */
    exportedVariable(variableName) {
        if (this.exportedVarsRendered && !this.exportedVariables.has(variableName)) {
            throw new Error('exportVariable(): Pipeline has already been produced, cannot call this function anymore');
        }
        this.exportedVariables.add(variableName);
        return outputs_1.makeCodePipelineOutput(this, variableName);
    }
    /**
     * Set the internal project value
     *
     * @internal
     */
    _setProject(project) {
        this._project = project;
    }
}
exports.CodeBuildStep = CodeBuildStep;
_a = JSII_RTTI_SYMBOL_1;
CodeBuildStep[_a] = { fqn: "@aws-cdk/pipelines.CodeBuildStep", version: "1.153.1" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZWJ1aWxkLXN0ZXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb2RlYnVpbGQtc3RlcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxvREFBb0Q7QUFJcEQsNENBQXlEO0FBQ3pELHFEQUF1RDtBQUN2RCwrQ0FBMkQ7QUE0RjNEOzs7Ozs7Ozs7Ozs7O0dBYUc7QUFDSCxNQUFhLGFBQWMsU0FBUSxxQkFBUztJQWdFMUMsWUFBWSxFQUFVLEVBQUUsS0FBeUI7UUFDL0MsS0FBSyxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUpGLHNCQUFpQixHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDL0MseUJBQW9CLEdBQUcsS0FBSyxDQUFDOzs7Ozs7Ozs7O1FBS25DLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztRQUNyQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDO1FBQy9DLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxLQUFLLENBQUMsZ0JBQWdCLENBQUM7UUFDaEQsSUFBSSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxlQUFlLEdBQUcsS0FBSyxDQUFDLGVBQWUsQ0FBQztRQUM3QyxJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQztRQUN2RCxJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUM7UUFDM0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO0tBQzlCO0lBRUQ7Ozs7T0FJRztJQUNILElBQVcsT0FBTztRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLDREQUE0RCxDQUFDLENBQUM7U0FDL0U7UUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7S0FDdEI7SUFFRDs7T0FFRztJQUNILElBQVcsY0FBYztRQUN2QixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDO0tBQ3BDO0lBRUQ7Ozs7OztPQU1HO0lBQ0gsSUFBVyxnQkFBZ0I7UUFDekIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQztRQUVqQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUM7WUFDckYsT0FBTyxFQUFFLEtBQUs7WUFDZCxHQUFHLEVBQUU7Z0JBQ0gsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUM7YUFDekQ7U0FDRixDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUVmLE9BQU8sNEJBQWUsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7S0FDL0Q7SUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O09BcUJHO0lBQ0ksZ0JBQWdCLENBQUMsWUFBb0I7UUFDMUMsSUFBSSxJQUFJLENBQUMsb0JBQW9CLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQzFFLE1BQU0sSUFBSSxLQUFLLENBQUMseUZBQXlGLENBQUMsQ0FBQztTQUM1RztRQUVELElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFekMsT0FBTyxnQ0FBc0IsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7S0FDbkQ7SUFFRDs7OztPQUlHO0lBQ0ksV0FBVyxDQUFDLE9BQTJCO1FBQzVDLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDO0tBQ3pCOztBQTVKSCxzQ0E2SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjb2RlYnVpbGQgZnJvbSAnQGF3cy1jZGsvYXdzLWNvZGVidWlsZCc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnQGF3cy1jZGsvYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnQGF3cy1jZGsvYXdzLWlhbSc7XG5pbXBvcnQgeyBEdXJhdGlvbiB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0IHsgU2hlbGxTdGVwLCBTaGVsbFN0ZXBQcm9wcyB9IGZyb20gJy4uL2JsdWVwcmludCc7XG5pbXBvcnQgeyBtZXJnZUJ1aWxkU3BlY3MgfSBmcm9tICcuL3ByaXZhdGUvYnVpbGRzcGVjcyc7XG5pbXBvcnQgeyBtYWtlQ29kZVBpcGVsaW5lT3V0cHV0IH0gZnJvbSAnLi9wcml2YXRlL291dHB1dHMnO1xuXG4vKipcbiAqIENvbnN0cnVjdGlvbiBwcm9wcyBmb3IgYSBDb2RlQnVpbGRTdGVwXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ29kZUJ1aWxkU3RlcFByb3BzIGV4dGVuZHMgU2hlbGxTdGVwUHJvcHMge1xuICAvKipcbiAgICogTmFtZSBmb3IgdGhlIGdlbmVyYXRlZCBDb2RlQnVpbGQgcHJvamVjdFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIEF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkXG4gICAqL1xuICByZWFkb25seSBwcm9qZWN0TmFtZT86IHN0cmluZztcblxuICAvKipcbiAgICogQWRkaXRpb25hbCBjb25maWd1cmF0aW9uIHRoYXQgY2FuIG9ubHkgYmUgY29uZmlndXJlZCB2aWEgQnVpbGRTcGVjXG4gICAqXG4gICAqIFlvdSBzaG91bGQgbm90IHVzZSB0aGlzIHRvIHNwZWNpZnkgb3V0cHV0IGFydGlmYWN0czsgdGhvc2VcbiAgICogc2hvdWxkIGJlIHN1cHBsaWVkIHZpYSB0aGUgb3RoZXIgcHJvcGVydGllcyBvZiB0aGlzIGNsYXNzLCBvdGhlcndpc2VcbiAgICogQ0RLIFBpcGVsaW5lcyB3b24ndCBiZSBhYmxlIHRvIGluc3BlY3QgdGhlIGFydGlmYWN0cy5cbiAgICpcbiAgICogU2V0IHRoZSBgY29tbWFuZHNgIHRvIGFuIGVtcHR5IGFycmF5IGlmIHlvdSB3YW50IHRvIGZ1bGx5IHNwZWNpZnlcbiAgICogdGhlIEJ1aWxkU3BlYyB1c2luZyB0aGlzIGZpZWxkLlxuICAgKlxuICAgKiBUaGUgQnVpbGRTcGVjIG11c3QgYmUgYXZhaWxhYmxlIGlubGluZS0taXQgY2Fubm90IHJlZmVyZW5jZSBhIGZpbGVcbiAgICogb24gZGlzay5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBCdWlsZFNwZWMgY29tcGxldGVseSBkZXJpdmVkIGZyb20gb3RoZXIgcHJvcGVydGllc1xuICAgKi9cbiAgcmVhZG9ubHkgcGFydGlhbEJ1aWxkU3BlYz86IGNvZGVidWlsZC5CdWlsZFNwZWM7XG5cbiAgLyoqXG4gICAqIFRoZSBWUEMgd2hlcmUgdG8gZXhlY3V0ZSB0aGUgU2ltcGxlU3ludGguXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gVlBDXG4gICAqL1xuICByZWFkb25seSB2cGM/OiBlYzIuSVZwYztcblxuICAvKipcbiAgICogV2hpY2ggc3VibmV0cyB0byB1c2UuXG4gICAqXG4gICAqIE9ubHkgdXNlZCBpZiAndnBjJyBpcyBzdXBwbGllZC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBBbGwgcHJpdmF0ZSBzdWJuZXRzLlxuICAgKi9cbiAgcmVhZG9ubHkgc3VibmV0U2VsZWN0aW9uPzogZWMyLlN1Ym5ldFNlbGVjdGlvbjtcblxuICAvKipcbiAgICogUG9saWN5IHN0YXRlbWVudHMgdG8gYWRkIHRvIHJvbGUgdXNlZCBkdXJpbmcgdGhlIHN5bnRoXG4gICAqXG4gICAqIENhbiBiZSB1c2VkIHRvIGFkZCBhY2NlcyB0byBhIENvZGVBcnRpZmFjdCByZXBvc2l0b3J5IGV0Yy5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyBwb2xpY3kgc3RhdGVtZW50cyBhZGRlZCB0byBDb2RlQnVpbGQgUHJvamVjdCBSb2xlXG4gICAqL1xuICByZWFkb25seSByb2xlUG9saWN5U3RhdGVtZW50cz86IGlhbS5Qb2xpY3lTdGF0ZW1lbnRbXTtcblxuICAvKipcbiAgICogQ3VzdG9tIGV4ZWN1dGlvbiByb2xlIHRvIGJlIHVzZWQgZm9yIHRoZSBDb2RlQnVpbGQgcHJvamVjdFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIEEgcm9sZSBpcyBhdXRvbWF0aWNhbGx5IGNyZWF0ZWRcbiAgICovXG4gIHJlYWRvbmx5IHJvbGU/OiBpYW0uSVJvbGU7XG5cbiAgLyoqXG4gICAqIENoYW5nZXMgdG8gZW52aXJvbm1lbnRcbiAgICpcbiAgICogVGhpcyBlbnZpcm9ubWVudCB3aWxsIGJlIGNvbWJpbmVkIHdpdGggdGhlIHBpcGVsaW5lJ3MgZGVmYXVsdFxuICAgKiBlbnZpcm9ubWVudC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBVc2UgdGhlIHBpcGVsaW5lJ3MgZGVmYXVsdCBidWlsZCBlbnZpcm9ubWVudFxuICAgKi9cbiAgcmVhZG9ubHkgYnVpbGRFbnZpcm9ubWVudD86IGNvZGVidWlsZC5CdWlsZEVudmlyb25tZW50O1xuXG4gIC8qKlxuICAgKiBXaGljaCBzZWN1cml0eSBncm91cCB0byBhc3NvY2lhdGUgd2l0aCB0aGUgc2NyaXB0J3MgcHJvamVjdCBuZXR3b3JrIGludGVyZmFjZXMuXG4gICAqIElmIG5vIHNlY3VyaXR5IGdyb3VwIGlzIGlkZW50aWZpZWQsIG9uZSB3aWxsIGJlIGNyZWF0ZWQgYXV0b21hdGljYWxseS5cbiAgICpcbiAgICogT25seSB1c2VkIGlmICd2cGMnIGlzIHN1cHBsaWVkLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIFNlY3VyaXR5IGdyb3VwIHdpbGwgYmUgYXV0b21hdGljYWxseSBjcmVhdGVkLlxuICAgKi9cbiAgcmVhZG9ubHkgc2VjdXJpdHlHcm91cHM/OiBlYzIuSVNlY3VyaXR5R3JvdXBbXTtcblxuICAvKipcbiAgICogVGhlIG51bWJlciBvZiBtaW51dGVzIGFmdGVyIHdoaWNoIEFXUyBDb2RlQnVpbGQgc3RvcHMgdGhlIGJ1aWxkIGlmIGl0J3NcbiAgICogbm90IGNvbXBsZXRlLiBGb3IgdmFsaWQgdmFsdWVzLCBzZWUgdGhlIHRpbWVvdXRJbk1pbnV0ZXMgZmllbGQgaW4gdGhlIEFXU1xuICAgKiBDb2RlQnVpbGQgVXNlciBHdWlkZS5cbiAgICpcbiAgICogQGRlZmF1bHQgRHVyYXRpb24uaG91cnMoMSlcbiAgICovXG4gIHJlYWRvbmx5IHRpbWVvdXQ/OiBEdXJhdGlvbjtcbn1cblxuLyoqXG4gKiBSdW4gYSBzY3JpcHQgYXMgYSBDb2RlQnVpbGQgUHJvamVjdFxuICpcbiAqIFRoZSBCdWlsZFNwZWMgbXVzdCBiZSBhdmFpbGFibGUgaW5saW5lLS1pdCBjYW5ub3QgcmVmZXJlbmNlIGEgZmlsZVxuICogb24gZGlzay4gSWYgeW91ciBjdXJyZW50IGJ1aWxkIGluc3RydWN0aW9ucyBhcmUgaW4gYSBmaWxlIGxpa2VcbiAqIGBidWlsZHNwZWMueW1sYCBpbiB5b3VyIHJlcG9zaXRvcnksIGV4dHJhY3QgdGhlbSB0byBhIHNjcmlwdFxuICogKHNheSwgYGJ1aWxkLnNoYCkgYW5kIGludm9rZSB0aGF0IHNjcmlwdCBhcyBwYXJ0IG9mIHRoZSBidWlsZDpcbiAqXG4gKiBgYGB0c1xuICogbmV3IHBpcGVsaW5lcy5Db2RlQnVpbGRTdGVwKCdTeW50aCcsIHtcbiAqICAgY29tbWFuZHM6IFsnLi9idWlsZC5zaCddLFxuICogfSk7XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGNsYXNzIENvZGVCdWlsZFN0ZXAgZXh0ZW5kcyBTaGVsbFN0ZXAge1xuICAvKipcbiAgICogTmFtZSBmb3IgdGhlIGdlbmVyYXRlZCBDb2RlQnVpbGQgcHJvamVjdFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHZhbHVlIHNwZWNpZmllZCBhdCBjb25zdHJ1Y3Rpb24gdGltZSwgdXNlIGRlZmF1bHRzXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcHJvamVjdE5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBWUEMgd2hlcmUgdG8gZXhlY3V0ZSB0aGUgU2ltcGxlU3ludGguXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gdmFsdWUgc3BlY2lmaWVkIGF0IGNvbnN0cnVjdGlvbiB0aW1lLCB1c2UgZGVmYXVsdHNcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSB2cGM/OiBlYzIuSVZwYztcblxuICAvKipcbiAgICogV2hpY2ggc3VibmV0cyB0byB1c2UuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gdmFsdWUgc3BlY2lmaWVkIGF0IGNvbnN0cnVjdGlvbiB0aW1lLCB1c2UgZGVmYXVsdHNcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBzdWJuZXRTZWxlY3Rpb24/OiBlYzIuU3VibmV0U2VsZWN0aW9uO1xuXG4gIC8qKlxuICAgKiBQb2xpY3kgc3RhdGVtZW50cyB0byBhZGQgdG8gcm9sZSB1c2VkIGR1cmluZyB0aGUgc3ludGhcbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyB2YWx1ZSBzcGVjaWZpZWQgYXQgY29uc3RydWN0aW9uIHRpbWUsIHVzZSBkZWZhdWx0c1xuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHJvbGVQb2xpY3lTdGF0ZW1lbnRzPzogaWFtLlBvbGljeVN0YXRlbWVudFtdO1xuXG4gIC8qKlxuICAgKiBDdXN0b20gZXhlY3V0aW9uIHJvbGUgdG8gYmUgdXNlZCBmb3IgdGhlIENvZGVCdWlsZCBwcm9qZWN0XG4gICAqXG4gICAqIEBkZWZhdWx0IC0gTm8gdmFsdWUgc3BlY2lmaWVkIGF0IGNvbnN0cnVjdGlvbiB0aW1lLCB1c2UgZGVmYXVsdHNcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSByb2xlPzogaWFtLklSb2xlO1xuXG4gIC8qKlxuICAgKiBCdWlsZCBlbnZpcm9ubWVudFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHZhbHVlIHNwZWNpZmllZCBhdCBjb25zdHJ1Y3Rpb24gdGltZSwgdXNlIGRlZmF1bHRzXG4gICAqL1xuICByZWFkb25seSBidWlsZEVudmlyb25tZW50PzogY29kZWJ1aWxkLkJ1aWxkRW52aXJvbm1lbnQ7XG5cbiAgLyoqXG4gICAqIFdoaWNoIHNlY3VyaXR5IGdyb3VwIHRvIGFzc29jaWF0ZSB3aXRoIHRoZSBzY3JpcHQncyBwcm9qZWN0IG5ldHdvcmsgaW50ZXJmYWNlcy5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyB2YWx1ZSBzcGVjaWZpZWQgYXQgY29uc3RydWN0aW9uIHRpbWUsIHVzZSBkZWZhdWx0c1xuICAgKi9cbiAgcmVhZG9ubHkgc2VjdXJpdHlHcm91cHM/OiBlYzIuSVNlY3VyaXR5R3JvdXBbXTtcblxuICAvKipcbiAgICogVGhlIG51bWJlciBvZiBtaW51dGVzIGFmdGVyIHdoaWNoIEFXUyBDb2RlQnVpbGQgc3RvcHMgdGhlIGJ1aWxkIGlmIGl0J3NcbiAgICogbm90IGNvbXBsZXRlLiBGb3IgdmFsaWQgdmFsdWVzLCBzZWUgdGhlIHRpbWVvdXRJbk1pbnV0ZXMgZmllbGQgaW4gdGhlIEFXU1xuICAgKiBDb2RlQnVpbGQgVXNlciBHdWlkZS5cbiAgICpcbiAgICogQGRlZmF1bHQgRHVyYXRpb24uaG91cnMoMSlcbiAgICovXG4gIHJlYWRvbmx5IHRpbWVvdXQ/OiBEdXJhdGlvbjtcblxuICBwcml2YXRlIF9wcm9qZWN0PzogY29kZWJ1aWxkLklQcm9qZWN0O1xuICBwcml2YXRlIF9wYXJ0aWFsQnVpbGRTcGVjPzogY29kZWJ1aWxkLkJ1aWxkU3BlYztcbiAgcHJpdmF0ZSByZWFkb25seSBleHBvcnRlZFZhcmlhYmxlcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICBwcml2YXRlIGV4cG9ydGVkVmFyc1JlbmRlcmVkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoaWQ6IHN0cmluZywgcHJvcHM6IENvZGVCdWlsZFN0ZXBQcm9wcykge1xuICAgIHN1cGVyKGlkLCBwcm9wcyk7XG5cbiAgICB0aGlzLnByb2plY3ROYW1lID0gcHJvcHMucHJvamVjdE5hbWU7XG4gICAgdGhpcy5idWlsZEVudmlyb25tZW50ID0gcHJvcHMuYnVpbGRFbnZpcm9ubWVudDtcbiAgICB0aGlzLl9wYXJ0aWFsQnVpbGRTcGVjID0gcHJvcHMucGFydGlhbEJ1aWxkU3BlYztcbiAgICB0aGlzLnZwYyA9IHByb3BzLnZwYztcbiAgICB0aGlzLnN1Ym5ldFNlbGVjdGlvbiA9IHByb3BzLnN1Ym5ldFNlbGVjdGlvbjtcbiAgICB0aGlzLnJvbGUgPSBwcm9wcy5yb2xlO1xuICAgIHRoaXMucm9sZVBvbGljeVN0YXRlbWVudHMgPSBwcm9wcy5yb2xlUG9saWN5U3RhdGVtZW50cztcbiAgICB0aGlzLnNlY3VyaXR5R3JvdXBzID0gcHJvcHMuc2VjdXJpdHlHcm91cHM7XG4gICAgdGhpcy50aW1lb3V0ID0gcHJvcHMudGltZW91dDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb2RlQnVpbGQgUHJvamVjdCBnZW5lcmF0ZWQgZm9yIHRoZSBwaXBlbGluZVxuICAgKlxuICAgKiBXaWxsIG9ubHkgYmUgYXZhaWxhYmxlIGFmdGVyIHRoZSBwaXBlbGluZSBoYXMgYmVlbiBidWlsdC5cbiAgICovXG4gIHB1YmxpYyBnZXQgcHJvamVjdCgpOiBjb2RlYnVpbGQuSVByb2plY3Qge1xuICAgIGlmICghdGhpcy5fcHJvamVjdCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYWxsIHBpcGVsaW5lLmJ1aWxkUGlwZWxpbmUoKSBiZWZvcmUgcmVhZGluZyB0aGlzIHByb3BlcnR5Jyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9wcm9qZWN0O1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBDb2RlQnVpbGQgUHJvamVjdCdzIHByaW5jaXBhbFxuICAgKi9cbiAgcHVibGljIGdldCBncmFudFByaW5jaXBhbCgpOiBpYW0uSVByaW5jaXBhbCB7XG4gICAgcmV0dXJuIHRoaXMucHJvamVjdC5ncmFudFByaW5jaXBhbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gdGhhdCBjYW4gb25seSBiZSBjb25maWd1cmVkIHZpYSBCdWlsZFNwZWNcbiAgICpcbiAgICogQ29udGFpbnMgZXhwb3J0ZWQgdmFyaWFibGVzXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQ29udGFpbnMgdGhlIGV4cG9ydGVkIHZhcmlhYmxlc1xuICAgKi9cbiAgcHVibGljIGdldCBwYXJ0aWFsQnVpbGRTcGVjKCk6IGNvZGVidWlsZC5CdWlsZFNwZWMgfCB1bmRlZmluZWQge1xuICAgIHRoaXMuZXhwb3J0ZWRWYXJzUmVuZGVyZWQgPSB0cnVlO1xuXG4gICAgY29uc3QgdmFyc0J1aWxkU3BlYyA9IHRoaXMuZXhwb3J0ZWRWYXJpYWJsZXMuc2l6ZSA+IDAgPyBjb2RlYnVpbGQuQnVpbGRTcGVjLmZyb21PYmplY3Qoe1xuICAgICAgdmVyc2lvbjogJzAuMicsXG4gICAgICBlbnY6IHtcbiAgICAgICAgJ2V4cG9ydGVkLXZhcmlhYmxlcyc6IEFycmF5LmZyb20odGhpcy5leHBvcnRlZFZhcmlhYmxlcyksXG4gICAgICB9LFxuICAgIH0pIDogdW5kZWZpbmVkO1xuXG4gICAgcmV0dXJuIG1lcmdlQnVpbGRTcGVjcyh2YXJzQnVpbGRTcGVjLCB0aGlzLl9wYXJ0aWFsQnVpbGRTcGVjKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWZlcmVuY2UgYSBDb2RlUGlwZWxpbmUgdmFyaWFibGUgZGVmaW5lZCBieSB0aGUgQ29kZUJ1aWxkU3RlcC5cbiAgICpcbiAgICogVGhlIHZhcmlhYmxlIG11c3QgYmUgc2V0IGluIHRoZSBzaGVsbCBvZiB0aGUgQ29kZUJ1aWxkIHN0ZXAgd2hlblxuICAgKiBpdCBmaW5pc2hlcyBpdHMgYHBvc3RfYnVpbGRgIHBoYXNlLlxuICAgKlxuICAgKiBAcGFyYW0gdmFyaWFibGVOYW1lIHRoZSBuYW1lIG9mIHRoZSB2YXJpYWJsZSBmb3IgcmVmZXJlbmNlLlxuICAgKiBAZXhhbXBsZVxuICAgKiAvLyBBY2Nlc3MgdGhlIG91dHB1dCBvZiBvbmUgQ29kZUJ1aWxkU3RlcCBpbiBhbm90aGVyIENvZGVCdWlsZFN0ZXBcbiAgICogZGVjbGFyZSBjb25zdCBwaXBlbGluZTogcGlwZWxpbmVzLkNvZGVQaXBlbGluZTtcbiAgICpcbiAgICogY29uc3Qgc3RlcDEgPSBuZXcgcGlwZWxpbmVzLkNvZGVCdWlsZFN0ZXAoJ1N0ZXAxJywge1xuICAgKiAgIGNvbW1hbmRzOiBbJ2V4cG9ydCBNWV9WQVI9aGVsbG8nXSxcbiAgICogfSk7XG4gICAqXG4gICAqIGNvbnN0IHN0ZXAyID0gbmV3IHBpcGVsaW5lcy5Db2RlQnVpbGRTdGVwKCdTdGVwMicsIHtcbiAgICogICBlbnY6IHtcbiAgICogICAgIElNUE9SVEVEX1ZBUjogc3RlcDEuZXhwb3J0ZWRWYXJpYWJsZSgnTVlfVkFSJyksXG4gICAqICAgfSxcbiAgICogICBjb21tYW5kczogWydlY2hvICRJTVBPUlRFRF9WQVInXSxcbiAgICogfSk7XG4gICAqL1xuICBwdWJsaWMgZXhwb3J0ZWRWYXJpYWJsZSh2YXJpYWJsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMuZXhwb3J0ZWRWYXJzUmVuZGVyZWQgJiYgIXRoaXMuZXhwb3J0ZWRWYXJpYWJsZXMuaGFzKHZhcmlhYmxlTmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZXhwb3J0VmFyaWFibGUoKTogUGlwZWxpbmUgaGFzIGFscmVhZHkgYmVlbiBwcm9kdWNlZCwgY2Fubm90IGNhbGwgdGhpcyBmdW5jdGlvbiBhbnltb3JlJyk7XG4gICAgfVxuXG4gICAgdGhpcy5leHBvcnRlZFZhcmlhYmxlcy5hZGQodmFyaWFibGVOYW1lKTtcblxuICAgIHJldHVybiBtYWtlQ29kZVBpcGVsaW5lT3V0cHV0KHRoaXMsIHZhcmlhYmxlTmFtZSk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBpbnRlcm5hbCBwcm9qZWN0IHZhbHVlXG4gICAqXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIF9zZXRQcm9qZWN0KHByb2plY3Q6IGNvZGVidWlsZC5JUHJvamVjdCkge1xuICAgIHRoaXMuX3Byb2plY3QgPSBwcm9qZWN0O1xuICB9XG59XG4iXX0=